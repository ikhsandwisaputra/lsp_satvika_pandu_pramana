<odoo>
    
    <record id="action_certification_app" model="ir.actions.act_window">
        <field name="name">Aplikasi Masuk</field>
        <field name="res_model">certification.application</field>
        <field name="view_mode">list,form,kanban</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Belum ada aplikasi masuk.
            </p>
        </field>
    </record>

    <record id="view_certification_app_list" model="ir.ui.view">
        <field name="name">certification.application.list</field>
        <field name="model">certification.application</field>
        <field name="arch" type="xml">
            <list string="Daftar Asesi" 
                  decoration-info="state == 'draft'" 
                  decoration-warning="state in ['submitted', 'revision']"
                  decoration-success="state in ['verified', 'scheduled']"
                  decoration-danger="state == 'rejected'">
                <field name="nik" string="NIK / ID"/>
                <field name="partner_id" string="Nama Asesi"/>
                
                <field name="application_type" string="Tipe" widget="badge" decoration-info="application_type == 'new'" decoration-warning="application_type == 'recert'"/>
                
                <field name="scheme" string="Skema"/>
                <field name="payment_amount" string="Tagihan" widget="monetary"/>
                <field name="payment_status" string="Pembayaran" widget="badge" 
                       decoration-danger="payment_status == 'unpaid'" 
                       decoration-warning="payment_status == 'pending'" 
                       decoration-success="payment_status == 'paid'"/>
                <field name="current_step" string="Step (1-2)" widget="badge"/>
                <field name="state" widget="badge" 
                       decoration-info="state == 'draft'"
                       decoration-warning="state in ['submitted', 'revision']" 
                       decoration-success="state in ['verified', 'scheduled']"
                       decoration-danger="state == 'rejected'"/>
            </list>
        </field>
    </record>

    <record id="view_certification_app_form" model="ir.ui.view">
        <field name="name">certification.application.form</field>
        <field name="model">certification.application</field>
        <field name="arch" type="xml">
            <form string="Detail Aplikasi">
                <header>
                    <!-- TOMBOL APPROVE -->
                    <button name="action_verify_documents" string="‚úÖ Approve (Terverifikasi)" 
                            type="object" class="btn-success" 
                            invisible="state not in ['submitted', 'revision']"
                            confirm="Yakin ingin menyetujui aplikasi ini? Status akan berubah menjadi TERVERIFIKASI."/>
                            
                    <!-- TOMBOL MINTA REVISI -->
                    <button name="action_request_revision" string="‚ö†Ô∏è Minta Revisi" 
                            type="object" class="btn-warning" 
                            invisible="state not in ['submitted']"/>
                    
                    <!-- TOMBOL TOLAK -->
                    <button name="action_reject" string="‚ùå Tolak Permanen" 
                            type="object" class="btn-danger" 
                            invisible="state not in ['submitted', 'revision']"
                            confirm="PERINGATAN: Aksi ini akan menolak aplikasi secara permanen. Yakin ingin melanjutkan?"/>
                    
                    <!-- TOMBOL KONFIRMASI PEMBAYARAN -->
                    <button name="action_confirm_payment" string="üí∞ Konfirmasi Pembayaran" 
                            type="object" class="btn-primary" 
                            invisible="state != 'payment'"
                            confirm="Konfirmasi bahwa pembayaran sudah diterima?"/>
                    
                    <!-- TOMBOL JADWALKAN UJIAN -->
                    <button name="action_set_schedule" string="üìÖ Jadwalkan Ujian" 
                            type="object" class="btn-info" 
                            invisible="state != 'verified'"/>
                    
                    <!-- TOMBOL HASIL ASESMEN -->
                    <button name="action_mark_passed" string="‚úì Nyatakan Lulus" 
                            type="object" class="btn-success" 
                            invisible="state != 'scheduled' or exam_result == 'passed'"
                            confirm="Yakin menyatakan asesi ini LULUS asesmen?"/>
                            
                    <button name="action_mark_failed" string="‚úó Tidak Lulus" 
                            type="object" class="btn-danger" 
                            invisible="state != 'scheduled' or exam_result != 'pending'"/>
                    
                    <!-- TOMBOL TERBITKAN SERTIFIKAT -->
                    <button name="action_issue_certificate" string="üèÜ Terbitkan Sertifikat"
                            type="object" class="btn-primary"
                            invisible="exam_result != 'passed' or cert_number"
                            confirm="Yakin menerbitkan sertifikat untuk asesi ini?"/>

                    <!-- TOMBOL RESET QUIZ (UJIAN ULANG) -->
                    <button name="action_reset_quiz" string="üîÑ Reset Quiz (Ujian Ulang)"
                            type="object" class="btn-secondary"
                            invisible="state != 'scheduled' or exam_result == 'pending'"
                            confirm="PERINGATAN: Aksi ini akan menghapus data ujian quiz peserta dan mengizinkan ujian ulang. Yakin ingin melanjutkan?"/>

                    <field name="state" widget="statusbar" statusbar_visible="draft,submitted,payment,verified,scheduled,certified"/>
                </header>
                <sheet>
                    <!-- ALERT BOX UNTUK CATATAN ADMIN -->
                    <div class="alert alert-warning" role="alert" invisible="not admin_note">
                        <strong>üìù Catatan Admin:</strong>
                        <field name="admin_note" nolabel="1" readonly="1"/>
                    </div>
                    
                    <div class="oe_title">
                        <label for="partner_id" string="Nama Kandidat"/>
                        <h1>
                            <field name="partner_id" readonly="1"/>
                        </h1>
                        <label for="scheme" string="Skema Pilihan"/>
                        <h3>
                            <field name="scheme" readonly="1"/> 
                            <span class="text-muted"> - </span>
                            <field name="application_type" readonly="1"/>
                        </h3>
                    </div>

                    <!-- FIELD CATATAN ADMIN (EDITABLE) -->
                    <group string="üìù Catatan Admin (Wajib diisi untuk Revisi/Tolak)">
                        <field name="admin_note" placeholder="Tuliskan alasan revisi atau penolakan di sini..."/>
                    </group>
                    <group>
                        <group string="Data Diri">
                            <field name="nik" readonly="1"/>
                            <field name="birth_date" readonly="1"/>
                            <field name="place_of_birth" readonly="1"/>
                            <field name="last_education" readonly="1"/>
                            <field name="phone" readonly="1"/>
                        </group>
                        <group string="Info Sertifikasi">
                            <field name="scheme" readonly="1"/>
                            <field name="application_type" readonly="1"/>
                            <field name="previous_cert_number" readonly="1" invisible="application_type != 'recert'"/>
                            
                            <separator/>
                            <field name="current_step" readonly="1"/>
                            <field name="create_date" string="Tanggal Daftar" readonly="1"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="üì∏ Preview Dokumen">
                            <div class="alert alert-success">
                                <strong>üí° Preview Mode:</strong> Gambar langsung tampil, klik untuk zoom. PDF klik untuk buka di tab baru.
                            </div>
                            
                            <!-- Preview Grid: 2 columns -->
                            <group>
                                <group string="üì∑ Pas Foto">
                                    <field name="preview_pas_foto" nolabel="1"/>
                                    <field name="revision_pas_foto" string="‚Ü∞ Minta Revisi"/>
                                </group>
                                <group string="ü™™ KTP">
                                    <field name="preview_ktp" nolabel="1"/>
                                    <field name="revision_ktp" string="‚Ü∞ Minta Revisi"/>
                                    <field name="is_ktp_valid"/>
                                </group>
                            </group>
                            
                            <group>
                                <group string="üìÑ CV / Daftar Riwayat Hidup">
                                    <field name="preview_cv" nolabel="1"/>
                                    <field name="revision_cv" string="‚Ü∞ Minta Revisi"/>
                                </group>
                                <group string="üéì Ijazah Terakhir">
                                    <field name="preview_ijazah" nolabel="1"/>
                                    <field name="revision_ijazah" string="‚Ü∞ Minta Revisi"/>
                                    <field name="is_ijazah_valid"/>
                                </group>
                            </group>
                            
                            <group>
                                <group string="üìú Sertifikat Pelatihan">
                                    <field name="preview_training" nolabel="1"/>
                                    <field name="revision_training" string="‚Ü∞ Minta Revisi"/>
                                </group>
                                <group string="üèÜ Sertifikat Level 1" invisible="scheme != 'level2'">
                                    <field name="preview_cert_level1" nolabel="1"/>
                                    <field name="revision_cert_level1" string="‚Ü∞ Minta Revisi"/>
                                </group>
                            </group>
                            
                            <separator string="üìù Catatan untuk Asesi (Jika Revisi)"/>
                            <field name="admin_note" placeholder="Contoh: Foto KTP buram, mohon upload ulang yang jelas."/>
                        </page>
                        
                        <page string="üìÅ File Asli (Download)">
                            <div class="alert alert-info">
                                Halaman ini untuk download file asli jika diperlukan.
                            </div>
                            
                            <group string="üìã Dokumen Dasar">
                                <group>
                                    <field name="pas_foto" widget="binary" filename="pas_foto_filename"/>
                                    <field name="ktp_file" widget="binary" filename="ktp_filename"/>
                                </group>
                                <group>
                                    <field name="cv_file" widget="binary" filename="cv_filename" string="CV"/>
                                    <field name="ijazah_file" widget="binary" filename="ijazah_filename"/>
                                    <field name="skck_file" widget="binary" filename="skck_filename"/>
                                </group>
                            </group>

                            <group string="üè• Dokumen Kesehatan &amp; Sertifikat">
                                <group>
                                    <field name="ishihara_test" widget="binary" filename="ishihara_filename" string="Surat Sehat &amp; Tes Buta Warna"/>
                                    <field name="is_ishihara_valid"/>
                                </group>
                                <group>
                                    <field name="training_cert" widget="binary" filename="training_filename" string="Sertifikat Pelatihan"/>
                                </group>
                            </group>
                            
                            <group string="üèÜ Dokumen Khusus Level 2" invisible="scheme != 'level2'">
                                <group>
                                    <field name="cert_level1_file" widget="binary" filename="cert_level1_filename" string="Sertifikat Level 1"/>
                                </group>
                                <group/>
                            </group>
                            
                            <group string="üîÑ Dokumen Resertifikasi" invisible="application_type != 'recert'">
                                <group>
                                    <field name="previous_cert_file" widget="binary" filename="previous_cert_filename" string="Sertifikat Lama"/>
                                </group>
                                <group>
                                    <field name="logbook_file" widget="binary" filename="logbook_filename" string="Logbook"/>
                                </group>
                            </group>
                            
                            <group string="üìé Dokumen Tambahan">
                                <group>
                                    <field name="additional_file" widget="binary" filename="additional_filename"/>
                                </group>
                                <group/>
                            </group>
                        </page>
                        
                        <page string="üí∞ Info Pembayaran" invisible="state not in ['payment', 'verified', 'scheduled']">
                            <group>
                                <group string="Detail Tagihan">
                                    <field name="payment_amount" widget="monetary"/>
                                    <field name="payment_status" widget="badge" 
                                           decoration-danger="payment_status == 'unpaid'" 
                                           decoration-warning="payment_status == 'pending'" 
                                           decoration-success="payment_status == 'paid'"/>
                                    <field name="invoice_id" readonly="1"/>
                                </group>
                                <group string="Info Xendit">
                                    <field name="xendit_invoice_id" readonly="1"/>
                                    <field name="xendit_status" widget="badge" 
                                           decoration-warning="xendit_status == 'pending'"
                                           decoration-success="xendit_status == 'paid'"
                                           decoration-muted="xendit_status == 'expired'"
                                           decoration-danger="xendit_status == 'failed'"/>
                                    <field name="xendit_payment_url" widget="url" readonly="1"/>
                                </group>
                            </group>
                            <group>
                                <group string="Info Transaksi">
                                    <field name="payment_method"/>
                                    <field name="payment_date"/>
                                    <field name="confirmed_by"/>
                                </group>
                                <group string="Bukti Pembayaran">
                                    <field name="payment_proof" widget="binary" filename="payment_proof_filename"/>
                                    <field name="payment_note" placeholder="Catatan tambahan terkait pembayaran..."/>
                                </group>
                            </group>
                        </page>
                        
                        <page string="üìÖ Jadwal Asesmen" invisible="state not in ['verified', 'scheduled']">
                            <div class="alert alert-info" invisible="state == 'scheduled'">
                                Isi jadwal di bawah ini, lalu klik tombol "üìÖ Jadwalkan Ujian" di atas.
                            </div>
                            <div class="alert alert-success" invisible="state != 'scheduled'">
                                <strong>‚úÖ Ujian sudah dijadwalkan!</strong> Info jadwal sudah terkirim ke asesi.
                            </div>
                            <group>
                                <group string="Waktu Ujian">
                                    <field name="exam_date"/>
                                    <field name="exam_time" widget="float_time"/>
                                </group>
                                <group string="Lokasi Ujian">
                                    <field name="exam_location" placeholder="Nama gedung/tempat"/>
                                    <field name="exam_room" placeholder="Ruangan/lantai"/>
                                </group>
                            </group>
                            <group string="Catatan untuk Asesi">
                                <field name="exam_notes" placeholder="Informasi tambahan seperti: bawa alat tulis, dresscode, dll..." nolabel="1"/>
                            </group>
                            <group string="Info Penjadwalan" invisible="state != 'scheduled'">
                                <field name="scheduled_by" readonly="1"/>
                                <field name="schedule_date" readonly="1"/>
                            </group>
                        </page>
                        
                        <page string="üèÜ Hasil &amp; Sertifikat" invisible="state not in ['scheduled', 'certified']">
                            <div class="alert alert-info" invisible="exam_result != 'pending'">
                                Setelah asesmen selesai, klik tombol "‚úì Nyatakan Lulus" atau "‚úó Tidak Lulus" di atas.
                            </div>
                            <div class="alert alert-success" invisible="exam_result != 'passed'">
                                <strong>‚úÖ Asesi dinyatakan LULUS!</strong> Silakan klik tombol "üèÜ Terbitkan Sertifikat" untuk menerbitkan sertifikat.
                            </div>
                            <div class="alert alert-danger" invisible="exam_result != 'failed'">
                                <strong>‚ùå Asesi dinyatakan TIDAK LULUS.</strong>
                            </div>
                            
                            <group>
                                <group string="Hasil Asesmen">
                                    <field name="exam_result" widget="badge"
                                           decoration-warning="exam_result == 'pending'"
                                           decoration-success="exam_result == 'passed'"
                                           decoration-danger="exam_result == 'failed'"/>
                                </group>
                                <group string="Info Sertifikat" invisible="not cert_number">
                                    <field name="cert_number"/>
                                    <field name="cert_issue_date"/>
                                    <field name="cert_valid_until"/>
                                    <field name="cert_issued_by"/>
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <menuitem id="menu_iso_root" 
              name="Sertifikasi ISO" 
              web_icon="iso17024_portal,static/description/icon.png" 
              sequence="10"/>

    <menuitem id="menu_iso_applications" 
              name="Aplikasi Masuk" 
              parent="menu_iso_root" 
              action="action_certification_app" 
              sequence="1"/>

</odoo>